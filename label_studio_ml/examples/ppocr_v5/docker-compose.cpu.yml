version: "3.8"

# CPU-only configuration for PP-OCRv5 ML Backend
# Use this if you don't have a GPU available

services:
  ppocr_v5:
    container_name: ppocr_v5
    image: heartexlabs/label-studio-ml-backend:ppocr-v5-cpu
    init: true
    build:
      context: .
      dockerfile: Dockerfile.cpu
      args:
        TEST_ENV: ${TEST_ENV:-false}
    environment:
      # Model selection
      - MODEL_VARIANT=${MODEL_VARIANT:-server}
      - OCR_LANG=${OCR_LANG:-ch}

      # Device (CPU only)
      - DEVICE=cpu

      # Score thresholds
      - SCORE_THRESHOLD=${SCORE_THRESHOLD:-0.5}
      - DET_SCORE_THRESHOLD=${DET_SCORE_THRESHOLD:-0.3}

      # Output options
      - OUTPUT_TYPE=${OUTPUT_TYPE:-polygon}
      - INCLUDE_TRANSCRIPTION=${INCLUDE_TRANSCRIPTION:-true}

      # Document preprocessing
      - USE_DOC_ORIENTATION=${USE_DOC_ORIENTATION:-false}
      - USE_DOC_UNWARPING=${USE_DOC_UNWARPING:-false}
      - USE_TEXTLINE_ORIENTATION=${USE_TEXTLINE_ORIENTATION:-false}

      # Server configuration
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - WORKERS=${WORKERS:-1}
      - THREADS=${THREADS:-8}
      - MODEL_DIR=/data/models

      # Basic auth (optional)
      - BASIC_AUTH_USER=${BASIC_AUTH_USER:-}
      - BASIC_AUTH_PASS=${BASIC_AUTH_PASS:-}

      # Label Studio connection (required for accessing uploaded images)
      # Get API key from Label Studio: Account & Settings -> Access Token
      - LABEL_STUDIO_URL=${LABEL_STUDIO_URL:-http://host.docker.internal:8080}
      - LABEL_STUDIO_API_KEY=${LABEL_STUDIO_API_KEY:-your_token_here}

    ports:
      - "9090:9090"
    volumes:
      - "./data/server:/data"
      - "./data/.file-cache:/data/models/.file-cache"
